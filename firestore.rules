rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Reglas para usuarios
    match /users/{userId} {
      // Permitir escribir solo al propio usuario autenticado
      allow write: if request.auth != null && request.auth.uid == userId;
      // Permitir crear si está autenticado
      allow create: if request.auth != null;
      // Permitir leer cualquier usuario para búsquedas por email (necesario para invitar a grupos)
      // Solo usuarios autenticados pueden leer otros usuarios
      allow read: if request.auth != null;
    }
    
    // Reglas para grupos
    match /groups/{groupId} {
      // Se puede leer si el usuario es miembro del grupo O si está autenticado (para ver información de invitación)
      // La aplicación verificará la membresía antes de permitir acciones
      allow read: if request.auth != null;
      
      // Solo se puede crear si el usuario está autenticado y es el creador
      // Verificamos que el usuario autenticado sea el creador y esté en memberIds
      allow create: if request.auth != null &&
                       request.auth.uid == request.resource.data.createdBy &&
                       request.auth.uid in request.resource.data.memberIds;
      
      // Solo se puede actualizar si el usuario es miembro del grupo
      allow update: if request.auth != null &&
                       request.auth.uid in resource.data.memberIds;
      
      // Solo el creador puede eliminar el grupo
      allow delete: if request.auth != null &&
                       request.auth.uid == resource.data.createdBy;
    }
    
    // Reglas para gastos (expenses)
    match /expenses/{expenseId} {
      // Solo se puede leer si el usuario está autenticado
      // (se verificará en la aplicación que pertenece al grupo)
      allow read: if request.auth != null;
      
      // Solo se puede crear si el usuario está autenticado
      allow create: if request.auth != null;
      
      // Solo se puede actualizar si el usuario está autenticado
      allow update: if request.auth != null;
      
      // Solo se puede eliminar si el usuario está autenticado
      allow delete: if request.auth != null;
    }
    
    // Reglas para notificaciones
    match /notifications/{notificationId} {
      // Solo se puede leer si el usuario es el destinatario
      allow read: if request.auth != null &&
                     request.auth.uid == resource.data.userId;
      
      // Solo se puede crear si el usuario está autenticado
      allow create: if request.auth != null;
      
      // Solo se puede actualizar si el usuario es el destinatario
      allow update: if request.auth != null &&
                       request.auth.uid == resource.data.userId;
      
      // Solo se puede eliminar si el usuario es el destinatario
      allow delete: if request.auth != null &&
                       request.auth.uid == resource.data.userId;
    }
    
    // Reglas para códigos de invitación de grupos
    match /group_invites/{inviteCode} {
      // Cualquier usuario autenticado puede leer códigos de invitación (para validar y unirse)
      allow read: if request.auth != null;
      
      // Solo se puede crear si el usuario está autenticado
      // Verificamos que el usuario sea miembro del grupo al que pertenece el código
      allow create: if request.auth != null;
      
      // No se permite actualizar códigos de invitación
      allow update: if false;
      
      // No se permite eliminar códigos de invitación (o solo el creador si queremos)
      allow delete: if false;
    }
  }
}

