rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Reglas para usuarios
    match /users/{userId} {
      // Permitir leer cualquier usuario (solo autenticados)
      // Necesario para búsquedas por email (invitar a grupos)
      allow read: if request.auth != null;
      
      // Permitir crear si está autenticado
      allow create: if request.auth != null;
      
      // Permitir actualizar solo al propio usuario autenticado
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Permitir eliminar:
      // 1. El propio usuario autenticado, O
      // 2. Un usuario ficticio (isFictional == true) que está siendo reclamado
      allow delete: if request.auth != null && 
                     (request.auth.uid == userId || 
                      (resource.data.get('isFictional', false) == true));
    }

    // Reglas para grupos
    match /groups/{groupId} {
      // Se puede leer si el usuario está autenticado
      allow read: if request.auth != null;
      
      // Solo se puede crear si el usuario está autenticado y es el creador
      allow create: if request.auth != null &&
                       request.auth.uid == request.resource.data.createdBy &&
                       request.auth.uid in request.resource.data.memberIds;
      
      // Se puede actualizar si:
      // 1. El usuario es miembro del grupo, O
      // 2. El usuario se está agregando a sí mismo al grupo (para unirse por código)
      allow update: if request.auth != null &&
                       (request.auth.uid in resource.data.memberIds ||
                        (request.auth.uid in request.resource.data.memberIds &&
                         !(request.auth.uid in resource.data.memberIds) &&
                         request.resource.data.memberIds.hasAll(resource.data.memberIds) &&
                         request.resource.data.memberIds.size() == resource.data.memberIds.size() + 1));
      
      // Solo el creador puede eliminar el grupo
      allow delete: if request.auth != null &&
                       request.auth.uid == resource.data.createdBy;
    }
    
    // Reglas para gastos (expenses)
    match /expenses/{expenseId} {
      // Solo se puede leer si el usuario está autenticado
      // (se verificará en la aplicación que pertenece al grupo)
      allow read: if request.auth != null;
      
      // Solo se puede crear si el usuario está autenticado
      allow create: if request.auth != null;
      
      // Solo se puede actualizar si el usuario está autenticado
      allow update: if request.auth != null;
      
      // Solo se puede eliminar si el usuario está autenticado
      allow delete: if request.auth != null;
    }
    
    // Reglas para notificaciones
    match /notifications/{notificationId} {
      // Solo se puede leer si el usuario es el destinatario
      allow read: if request.auth != null &&
                     request.auth.uid == resource.data.userId;
      
      // Solo se puede crear si el usuario está autenticado
      allow create: if request.auth != null;
      
      // Solo se puede actualizar si el usuario es el destinatario
      allow update: if request.auth != null &&
                       request.auth.uid == resource.data.userId;
      
      // Solo se puede eliminar si el usuario es el destinatario
      allow delete: if request.auth != null &&
                       request.auth.uid == resource.data.userId;
    }
    
    // Reglas para códigos de invitación de grupos
    match /group_invites/{inviteCode} {
      // Cualquier usuario autenticado puede leer códigos de invitación (para validar y unirse)
      allow read: if request.auth != null;
      
      // Solo se puede crear si el usuario está autenticado
      // Verificamos que el usuario sea miembro del grupo al que pertenece el código
      allow create: if request.auth != null;
      
      // No se permite actualizar códigos de invitación
      allow update: if false;
      
      // No se permite eliminar códigos de invitación (o solo el creador si queremos)
      allow delete: if false;
    }

    // Configuración pública de la app (versiones mínimas, etc.)
    match /app_config/{document=**} {
      // Cualquier cliente puede leer esta configuración para saber si debe actualizarse
      allow read: if true;
      // Solo el backend/console (privilegio admin) debería escribir
      allow write: if false;
    }
  }
}
